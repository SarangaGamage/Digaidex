<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Authentication (WebAuthn) New</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #333;
        }

        p {
            font-size: 16px;
            color: #555;
            margin: 10px 0;
        }

        .status-message {
            font-weight: bold;
            color: #007bff;
            margin-top: 15px;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        #registerBtn {
            background-color: #28a745;
            color: white;
        }

        #registerBtn:hover {
            background-color: #218838;
        }

        #checkinBtn {
            background-color: #007bff;
            color: white;
        }

        #checkinBtn:hover {
            background-color: #0056b3;
        }

        #checkOutBtn {
            background-color: #dc3545;
            color: white;
        }

        #checkOutBtn:hover {
            background-color: #c82333;
        }

        button:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
        .disabled-btn {
            background-color: gray !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ROCKLAND (PVT) Ltd</h2>
        <p id="locationStatus">üìç Checking location...</p>
        <p id="biometricAuthenticationStatus">üîí Awaiting authentication...</p>

        <button id="registerBtn" onclick="registerBiometricCredential()">üìù Register Sales Person</button>
        <button id="checkinBtn" onclick="authenticateWithBiometrics()">‚úÖ Check In</button>
        <button id="checkOutBtn" onclick="authenticateWithBiometrics()">‚ùå Check Out</button>

        <p class="status-message" id="status"></p>
    </div>

    <script>

        function saveToStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function getFromStorage(key) {
            return JSON.parse(localStorage.getItem(key));
        }

        function checkBiometricRegistration() {
            const credentialData = getFromStorage("biometric_credential");
            if (credentialData) {
                document.getElementById("registerBtn").style.display = "none";
            }
        }

        async function registerBiometricCredential() {
            if (!window.PublicKeyCredential) {
                document.getElementById("status").innerText = "Biometric authentication is not supported on this device.";
                return;
            }

            const challenge = new Uint8Array(32);
            const userId = new Uint8Array(16); 

            try {
                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge: challenge,
                        rp: { name: "My Secure App" },
                        user: {
                            id: userId,
                            name: "user@example.com",
                            displayName: "User Example"
                        },
                        pubKeyCredParams: [{ type: "public-key", alg: -7 }], 
                        authenticatorSelection: { userVerification: "required" },
                        timeout: 60000,
                        attestation: "default"
                    }
                });

                console.log("Biometric Credential Registered!", credential);
                document.getElementById("status").innerText = "Biometric Registration Successful!";

                saveToStorage("biometric_credential", {
                    credentialId: credential.id,
                    rawId: Array.from(new Uint8Array(credential.rawId)),
                    response: {
                        clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
                        attestationObject: Array.from(new Uint8Array(credential.response.attestationObject))
                    }
                });

                document.getElementById("registerBtn").style.display = "none";

            } catch (error) {
                console.error("Biometric Registration Failed:", error);
        
                document.getElementById("status").innerText = "‚ùå Biometric authentication failed";
            }
        }

        async function authenticateWithBiometrics() {
            if (!window.PublicKeyCredential) {
                document.getElementById("status").innerText = "Biometric authentication is not supported on this device.";
                return;
            }

            const challenge = new Uint8Array(32); 
            const storedCredential = getFromStorage("biometric_credential");

            if (!storedCredential) {
                document.getElementById("status").innerText = "No biometric credentials found. Please register first.";
                return;
            }

            try {
                const assertion = await navigator.credentials.get({
                    publicKey: {
                        challenge: challenge,
                        allowCredentials: [{
                            id: new Uint8Array(storedCredential.rawId),
                            type: "public-key"
                        }],
                        userVerification: "required"
                    }
                });

                console.log("Biometric authentication successful!", assertion);
                document.getElementById("status").innerText = "‚úÖ User checkin successfull!";
            } catch (error) {
                console.error("Biometric authentication failed:", error);
                document.getElementById("status").innerText = "‚ùå Biometric authentication failed";
            }
        }

function getCurrentLocationAndCheckRadius(targetLat, targetLon, radiusInKm) {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                console.log(`User Location: Latitude ${userLat}, Longitude ${userLon}`);

                const distance = calculateDistance(userLat, userLon, targetLat, targetLon);

                console.log(`Distance from target: ${distance.toFixed(2)} km`);

                if (distance <= radiusInKm) {
                    document.getElementById("locationStatus").innerHTML = "‚úÖ User is within the allowed radius!";
                } else {
                    console.log("");
                    document.getElementById("locationStatus").innerHTML = "‚ùå User is outside the allowed radius.";
                    document.getElementById("checkinBtn").disabled = true;
                    document.getElementById("registerBtn").disabled = true;
                    document.getElementById("registerBtn").classList.add("disabled-btn");
                    document.getElementById("checkinBtn").classList.add("disabled-btn");
                }
            },
            (error) => {
                console.error("Error getting location:", error.message);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    } else {
        console.error("Geolocation is not supported by this browser.");
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function toRadians(degrees) {
    return degrees * (Math.PI / 180);
}

const targetLatitude = 6.972882;
const targetLongitude = 79.903265;
const allowedRadiusKm = 0.05; 



        window.onload = function () {
            checkBiometricRegistration();
            getCurrentLocationAndCheckRadius(targetLatitude, targetLongitude, allowedRadiusKm);
        };
    </script>
</body>
</html>
