<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROCKLAND Sales Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #333;
        }

        p {
            font-size: 16px;
            color: #555;
            margin: 10px 0;
        }

        .status-message {
            font-weight: bold;
            color: #007bff;
            margin-top: 15px;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        #newSalesPersonBtn {
            background-color: #28a745;
            color: white;
        }

        #newSalesPersonBtn:hover {
            background-color: #218838;
        }

        #checkinBtn {
            background-color: #007bff;
            color: white;
        }

        #checkinBtn:hover {
            background-color: #0056b3;
        }

        #registerUserBtn {
            background-color: #ff9800;
            color: white;
        }

        #registerUserBtn:hover {
            background-color: #e68900;
        }

        .disabled-btn {
            background-color: gray !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .hidden {
            display: none;
        }

        .input-field {
            width: 93%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ROCKLAND (PVT) Ltd</h2>
        <p id="locationStatus">üìç Checking location...</p>
        <p id="biometricAuthenticationStatus"></p>

        <!-- Buttons (Initially Visible) -->
        <button id="newSalesPersonBtn" onclick="showRegistrationForm()">üìù I'm a new sales person</button>
        <button id="checkinBtn" onclick="validateLocationAndCheckIn()">‚úÖ Check In</button>

        <!-- Registration Form (Initially Hidden) -->
        <div id="registrationForm" class="hidden">
            <label style="float: left;"> Name: </label>
            <input type="text" id="name" class="input-field" placeholder="Enter your name">

            <label style="float: left;"> Mobile: </label>
            <input type="number" id="mobile" class="input-field" placeholder="Enter your mobile number">

            <button id="registerUserBtn" onclick="registerUser()">üìå Register User</button>
        </div>

        <!-- Displayed After Check-in -->
        <p id="loggedInUser" class="status-message hidden"></p>
    </div>

    <script>
        let userLat, userLon;
        const allowedRadiusKm = 0.05; // 50 meters
        const targetLatitude = 6.972775262641707; // Example target latitude (update this)
        const targetLongitude = 79.90303564604743; // Example target longitude (update this)

        function showRegistrationForm() {
            document.getElementById("newSalesPersonBtn").classList.add("hidden");
            document.getElementById("checkinBtn").classList.add("hidden");
            document.getElementById("registrationForm").classList.remove("hidden");
        }

        function registerUser() {
            const name = document.getElementById("name").value;
            const mobile = document.getElementById("mobile").value;

            if (!name || !mobile) {
                alert("Please enter both Name and Mobile number.");
                return;
            }

            localStorage.setItem("sales_person", JSON.stringify({ name, mobile }));

            registerBiometricCredential();
        }

        async function registerBiometricCredential() {
            if (!window.PublicKeyCredential) {
                document.getElementById("biometricAuthenticationStatus").innerText = "‚ùå Biometric authentication is not supported on this device.";
                return;
            }

            const challenge = new Uint8Array(32);
            const userId = new Uint8Array(16);

            try {
                const credential = await navigator.credentials.create({
                    publicKey: {
                        challenge: challenge,
                        rp: { name: "My Secure App" },
                        user: {
                            id: userId,
                            name: "user@example.com",
                            displayName: "User Example"
                        },
                        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                        authenticatorSelection: { userVerification: "required" },
                        timeout: 60000,
                        attestation: "none"
                    }
                });

                localStorage.setItem("biometric_credential", JSON.stringify({
                    credentialId: credential.id,
                    rawId: Array.from(new Uint8Array(credential.rawId)),
                    response: {
                        clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
                        attestationObject: Array.from(new Uint8Array(credential.response.attestationObject))
                    }
                }));

                document.getElementById("biometricAuthenticationStatus").innerText = "‚úÖ Registration Successful!";
                resetToHomePage();
            } catch (error) {
                console.error("Biometric Registration Failed:", error);
                document.getElementById("biometricAuthenticationStatus").innerText = "‚ùå Biometric authentication failed";
            }
        }

        function resetToHomePage() {
            document.getElementById("registrationForm").classList.add("hidden");
            document.getElementById("newSalesPersonBtn").classList.remove("hidden");
            document.getElementById("checkinBtn").classList.remove("hidden");
        }

        function disableButtons() {
            document.getElementById("newSalesPersonBtn").disabled = true;
            document.getElementById("newSalesPersonBtn").classList.add("disabled-btn");
            document.getElementById("checkinBtn").disabled = true;
            document.getElementById("checkinBtn").classList.add("disabled-btn");
        }

        function getCurrentLocationAndCheckAccess() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;

                        console.log(`User Location: Latitude ${userLat}, Longitude ${userLon}`);

                        const distance = calculateDistance(userLat, userLon, targetLatitude, targetLongitude);
                        console.log(`Distance from target: ${distance.toFixed(2)} km`);

                        if (distance > allowedRadiusKm) {
                            document.getElementById("locationStatus").innerText = "‚ùå User is outside the allowed radius. Access Denied!";
                            disableButtons();
                            return;
                        }

                        document.getElementById("locationStatus").innerText = "‚úÖ User is within the allowed radius!";
                    },
                    (error) => {
                        console.error("Error getting location:", error.message);
                        document.getElementById("locationStatus").innerText = "‚ö†Ô∏è Location error! User denied the location access or having trouble getting the location!";
                        disableButtons();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            return R * 2 * Math.asin(Math.sqrt(Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) ** 2));
        }

        

        window.onload = getCurrentLocationAndCheckAccess;
    </script>
</body>
</html>
